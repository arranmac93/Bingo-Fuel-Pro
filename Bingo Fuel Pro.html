<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bingo Fuel Pro</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --text:#0f172a; --muted:#475569; --border:#dbe1ea;
    --brand:#2962ff; --brand-600:#1f4ad6; --brand-300:#90b2ff;
    --danger:#dc2626; --warn:#b45309;
    --ring: rgba(41,98,255,.18);
    --panel-elev: 0 12px 30px -10px rgba(2,6,23,.12), 0 8px 20px -12px rgba(2,6,23,.06);
    --result-bg:#eef4ff; --result-text:#103cbe; --result-shadow:0 10px 24px -12px rgba(41,98,255,.35);
    --overlay: rgba(2,6,23,.45);
    --tooltip-bg: rgba(15,23,42,.92); --tooltip-tx:#fff;
    --sticky-bg: rgba(255,255,255,.85); --sticky-blur: blur(6px);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --text:#e5edf8; --muted:#b6c2d9; --border:#1f2a44;
    --brand:#6aa3ff; --brand-600:#4b8cff; --brand-300:#9ec1ff;
    --ring: rgba(106,163,255,.25);
    --result-bg:#0e1a33; --result-text:#9ec1ff; --result-shadow:0 10px 24px -12px rgba(106,163,255,.35);
    --overlay: rgba(0,0,0,.55);
    --tooltip-bg: rgba(8,12,24,.96); --tooltip-tx:#eaf2ff;
    --sticky-bg: rgba(15,23,42,.85);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  button{font:inherit} a{color:inherit; text-decoration:none}

  /* Top Bar */
  .topbar{
    position:fixed; inset:0 0 auto 0; height:56px; background:var(--panel); border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:.75rem; padding:0 .75rem; z-index:30;
  }
  .brand{display:flex; align-items:center; gap:.5rem; font-weight:800; letter-spacing:.2px}
  .iconbtn{width:40px; height:40px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--border); background:transparent; cursor:pointer}
  .iconbtn:focus-visible, .btn:focus-visible, .in:focus-visible{outline:2px solid var(--brand-300); outline-offset:2px}

  /* Sidebar */
  .overlay{position:fixed; inset:0; background:var(--overlay); opacity:0; visibility:hidden; transition:.25s; z-index:35}
  .overlay.show{opacity:1; visibility:visible}
  .sidenav{
    position:fixed; top:0; left:0; height:100%; width:300px; background:var(--panel); border-right:1px solid var(--border);
    transform:translateX(-100%); transition:transform .28s cubic-bezier(.22,.61,.36,1); z-index:40; display:flex; flex-direction:column;
  }
  .sidenav.open{transform:translateX(0)}
  .sidehdr{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700}
  .sidegrp{padding:12px 16px; border-bottom:1px solid var(--border)}
  .pillrow{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:transparent; cursor:pointer}
  .pill[aria-pressed="true"]{background:var(--brand); color:#fff; border-color:var(--brand-600)}
  .fueltypes{display:none; margin-top:10px}
  .fueltypes.show{display:block}

  /* Layout */
  .container{padding:88px 16px 24px; display:flex; justify-content:center}
  .card{width:100%; max-width:760px; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:var(--panel-elev); display:flex; flex-direction:column; gap:18px}
  .group{border:1px solid var(--border); border-radius:14px; padding:16px}
  .group-title{margin:0 0 10px; font-weight:800}

  .grid{display:grid; gap:16px}
  @media (min-width:768px){ .grid-2{grid-template-columns:1fr 1fr} }

  /* Inputs */
  .field{display:flex; flex-direction:column; gap:8px}
  label{font-weight:700; color:var(--muted); display:flex; align-items:center; gap:6px}
  .input-wrap{position:relative}
  .in{
    width:100%; padding:12px 54px 12px 14px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text);
    transition:border-color .15s, box-shadow .15s;
  }
  .in:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
  .unit-inside{
    position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.65; font-weight:800; pointer-events:none;
  }
  .unit-inside.fade{animation:fadeUnit .25s}
  @keyframes fadeUnit{from{opacity:.25}to{opacity:.65}}
  .error{display:none; color:var(--danger); font-size:.92rem}

  /* Tooltips */
  .hint{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:999px; background:#e5e7eb; color:#111; font-size:12px; cursor:pointer}
  [data-theme="dark"] .hint{background:#1c2742; color:#e5edf8}
  .tooltip{position:fixed; max-width:280px; background:var(--tooltip-bg); color:var(--tooltip-tx); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:10px; font-size:.95rem; line-height:1.35; z-index:60; box-shadow:0 10px 30px -12px rgba(0,0,0,.4); opacity:0; transform:translateY(-4px); transition:.15s}
  .tooltip.show{opacity:1; transform:translateY(0)}

  /* Buttons & Results */
  .btn{display:inline-flex; justify-content:center; align-items:center; gap:.5rem; width:100%; padding:12px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:800; transition:transform .05s, filter .15s, box-shadow .2s}
  .btn:active{transform:translateY(1px)}
  .btn-muted{background:#e7ebf3; color:#111827}
  [data-theme="dark"] .btn-muted{background:#1c2742; color:#e5edf8}

  .result{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; background:var(--result-bg); color:var(--result-text); border:1px solid var(--border); border-radius:12px; padding:12px 14px; box-shadow:var(--result-shadow)}
  .result + .result { margin-top: 8px; }
  .pulse{animation:pulseGlow .6s ease-out}
  @keyframes pulseGlow{
    0%{box-shadow:var(--result-shadow), 0 0 0 0 rgba(41,98,255,.0)}
    40%{box-shadow:var(--result-shadow), 0 0 0 10px rgba(41,98,255,.12)}
    100%{box-shadow:var(--result-shadow), 0 0 0 0 rgba(41,98,255,.0)}
  }
  .warn{border-color:var(--warn); outline:2px solid rgba(180,83,9,.25)}

  /* Step 2 & Timer */
  .step2{border-top:1px solid var(--border); margin-top:8px; padding-top:16px; display:none}
  .step2.show{display:block; animation:slideDown .25s ease-out}
  @keyframes slideDown{from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:translateY(0)}}
  .timer{display:none; text-align:center}
  .timer-readout{font-variant-numeric:tabular-nums; letter-spacing:.5px; font-size:36px; font-weight:800; margin-bottom:10px}
  .timbtn{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:transparent; cursor:pointer; margin:0 6px}

  /* Splash */
  .splash{position:fixed; inset:0; display:grid; place-items:center; gap:12px; background:var(--bg); z-index:50; transition:opacity .6s ease, transform .6s ease}
  .splash.fade{opacity:0; pointer-events:none; transform:scale(1.02)}
  .splash .logo{width:84px; height:84px}

  /* Slim sticky results bar */
  .sticky-results{
    position:sticky; top:60px; z-index:20; backdrop-filter:var(--sticky-blur); background:var(--sticky-bg);
    border:1px solid var(--border); border-radius:10px; padding:6px 10px; margin-bottom:10px; display:none; gap:10px; justify-content:space-between; align-items:center;
    font-size:14px;
  }
  .sticky-results strong{font-weight:800}
  .sticky-results.show{display:flex}

  .nudge{ animation:nudge 800ms ease-out }
  @keyframes nudge{ 0%{ box-shadow:0 0 0 4px var(--ring); border-color:var(--brand);} 100%{ box-shadow:none; } }

  /* Compact segmented control (Reserve mode) */
  .seg{display:inline-flex; border:1px solid var(--border); border-radius:999px; overflow:hidden; margin-left:auto}
  .seg button{padding:6px 10px; border:0; background:transparent; cursor:pointer; font-weight:700; color:var(--muted)}
  .seg button[aria-pressed="true"]{background:var(--brand); color:#fff}

  .row{display:flex; align-items:center; gap:8px}
  .hidden{display:none}
</style>
</head>
<body>
  <!-- Splash -->
  <div id="splash" class="splash" aria-hidden="true">
    <div style="display:flex; flex-direction:column; align-items:center; text-align:center">
      <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#2962ff"/><stop offset="1" stop-color="#9ec1ff"/></linearGradient></defs>
        <path d="M32 10c8 10 12 18 12 24a12 12 0 1 1-24 0c0-6 4-14 12-24z" fill="url(#g)"/>
        <path d="M8 38l20-4 4-12 4 12 20 4-24 2-24-2z" fill="#0b1e68"/>
      </svg>
      <div style="height:8px"></div>
      <h1 style="margin:0; font-size:24px; font-weight:800">Bingo Fuel Pro</h1>
      <p style="margin:.25rem 0 0; color:var(--muted)">Holding fuel & timeâ€”fast and clear</p>
    </div>
  </div>

  <!-- Top Bar -->
  <header class="topbar">
    <button id="openNav" class="iconbtn" aria-label="Open menu" aria-controls="sidenav" aria-expanded="false">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
    </button>
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 64 64" aria-hidden="true">
        <path d="M32 10c8 10 12 18 12 24a12 12 0 1 1-24 0c0-6 4-14 12-24z" fill="#2962ff"/>
        <path d="M8 38l20-4 4-12 4 12 20 4-24 2-24-2z" fill="#13307a"/>
      </svg>
      <span>Bingo Fuel Pro</span>
    </div>
    <div style="margin-left:auto; display:flex; gap:.5rem">
      <button id="toggleTheme" class="iconbtn" aria-label="Toggle dark mode" title="Toggle dark mode">
        <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 3a9 9 0 1 0 9 9 7 7 0 0 1-9-9z"/></svg>
      </button>
    </div>
  </header>

  <!-- Sidebar -->
  <div id="overlay" class="overlay" tabindex="-1" aria-hidden="true"></div>
  <aside id="sidenav" class="sidenav" role="navigation" aria-label="Settings">
    <div class="sidehdr">
      <span>Settings</span>
      <button id="closeNav" class="iconbtn" aria-label="Close menu">
        <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M6 6l12 12M18 6L6 18"/></svg>
      </button>
    </div>
    <div class="sidegrp">
      <div style="font-weight:800; margin-bottom:8px">Fuel Units</div>
      <div class="pillrow" role="group" aria-label="Units">
        <button class="pill" data-unit="lbs" aria-pressed="true">LBS</button>
        <button class="pill" data-unit="kg" aria-pressed="false">KG</button>
        <button class="pill" data-unit="gal" aria-pressed="false">GAL</button>
      </div>
      <div id="fuelTypes" class="fueltypes">
        <div style="font-weight:800; margin:12px 0 8px">Fuel Type (lb/gal)</div>
        <div class="pillrow">
          <button class="pill" data-fuel="100LL" aria-pressed="true">100LL (6.01)</button>
          <button class="pill" data-fuel="AVGAS100" aria-pressed="false">Avgas 100 (6.00)</button>
          <button class="pill" data-fuel="MOGAS" aria-pressed="false">MoGas (6.20)</button>
          <button class="pill" data-fuel="JETA" aria-pressed="false">Jet A (6.84)</button>
          <button class="pill" data-fuel="JETB" aria-pressed="false">Jet B (6.50)</button>
        </div>
      </div>
    </div>
    <div class="sidegrp">
      <button class="pill" id="toggleThemeSide" aria-pressed="false">ðŸŒ™ Dark Mode</button>
    </div>
  </aside>

  <!-- Main -->
  <div class="container">
    <main class="card" role="main" aria-labelledby="title">

      <!-- Sticky summary -->
      <div id="sticky" class="sticky-results" aria-live="polite">
        <div><strong>Bingo:</strong> <span id="stickyBingo">â€”</span></div>
        <div><strong>Holding:</strong> <span id="stickyHold">â€”</span></div>
      </div>

      <h2 id="title" class="group-title">Bingo Fuel & Holding Fuel</h2>

      <!-- Stage 1 -->
      <section class="group" aria-label="Inputs">
        <h3 class="group-title">Stage 1 â€” Planning Inputs</h3>

        <div class="grid grid-2">
          <div class="field">
            <label for="fob">Fuel On Board <span class="hint" data-tip="Current usable fuel on board at the start of this calculation.">?</span></label>
            <div class="input-wrap">
              <input id="fob" class="in" type="number" inputmode="decimal" step="0.1" min="0.01" autocomplete="off" placeholder="Enter fuel on board">
              <span class="unit-inside" data-role="fob">lbs</span>
            </div>
            <div id="e-fob" class="error">Fuel on board must be greater than zero.</div>
          </div>

          <div class="field">
            <label for="toDest">Fuel to Destination <span class="hint" data-tip="Estimated fuel burn from present position to your destination airport.">?</span></label>
            <div class="input-wrap">
              <input id="toDest" class="in" type="number" inputmode="decimal" step="0.1" min="0" autocomplete="off" placeholder="Enter fuel to destination">
              <span class="unit-inside" data-role="dest">lbs</span>
            </div>
            <div id="e-dest" class="error">Enter a valid number.</div>
          </div>

          <div class="field">
            <label for="toAlt">Fuel to Alternate <span class="hint" data-tip="Fuel required to fly from destination to your alternate airport. If more than one alternate is filed, enter the fuel to the furthest alternate.">?</span></label>
            <div class="input-wrap">
              <input id="toAlt" class="in" type="number" inputmode="decimal" step="0.1" min="0" autocomplete="off" placeholder="Enter fuel to alternate">
              <span class="unit-inside" data-role="alt">lbs</span>
            </div>
            <div id="e-alt" class="error">Enter a valid number.</div>
          </div>

          <!-- Reserve heading row with compact toggle -->
          <div class="row" style="grid-column:1/-1; justify-content:space-between">
            <label style="margin:0;font-weight:800">Reserve</label>
            <div class="seg" role="group" aria-label="Reserve mode">
              <button class="segbtn" data-resmode="volume" aria-pressed="true" title="Enter a fixed fuel quantity">Volume</button>
              <button class="segbtn" data-resmode="time" aria-pressed="false" title="Enter a time with a burn rate">Time</button>
            </div>
          </div>

          <!-- Reserve as Volume -->
          <div id="resVolumeBlock" class="field" style="grid-column:1/-1">
            <label for="reserve">Reserve Fuel (Volume) <span class="hint" data-tip="Final reserve fuel upon landing as a quantity in the selected units.">?</span></label>
            <div class="input-wrap">
              <input id="reserve" class="in" type="number" inputmode="decimal" step="0.1" min="0" autocomplete="off" placeholder="Enter reserve volume">
              <span class="unit-inside" data-role="res">lbs</span>
            </div>
            <div id="e-res" class="error">Enter a valid number.</div>
          </div>

          <!-- Reserve as Time -->
          <div id="resTimeBlock" class="field hidden" style="grid-column:1/-1">
            <div class="grid grid-2">
              <div class="field">
                <label for="reserveTime">Reserve Time <span class="hint" data-tip="Reserve expressed as time to hold or fly, in minutes.">?</span></label>
                <div class="input-wrap">
                  <input id="reserveTime" class="in" type="number" inputmode="decimal" step="1" min="1" autocomplete="off" placeholder="Enter reserve time (min)">
                  <span class="unit-inside">min</span>
                </div>
                <div id="e-resTime" class="error">Enter reserve time in minutes.</div>
              </div>
              <div class="field">
                <label for="reserveRate">Reserve Burn Rate <span class="hint" data-tip="Fuel burn rate used for reserve calculation (units per hour).">?</span></label>
                <div class="input-wrap">
                  <input id="reserveRate" class="in" type="number" inputmode="decimal" step="0.1" min="0.01" autocomplete="off" placeholder="Enter reserve burn rate">
                  <span class="unit-inside" data-role="resrate">lbs/hr</span>
                </div>
                <div id="e-resRate" class="error">Enter reserve burn rate.</div>
              </div>
            </div>
          </div>
        </div>

        <section id="resultBingo" class="result hidden" aria-live="polite" style="margin-top:10px">
          <div><strong>Bingo Fuel</strong></div>
          <div><span id="bingoVal">â€”</span> <span id="u-bingo" style="opacity:.8;font-weight:800">lbs</span></div>
        </section>

        <section id="resultHold" class="result hidden" aria-live="polite">
          <div><strong>Fuel Remaining for Holding</strong></div>
          <div><span id="holdVal">â€”</span> <span id="u-hold" style="opacity:.8;font-weight:800">lbs</span></div>
        </section>
      </section>

      <!-- Stage 2 -->
      <section class="group step2" id="step2" aria-label="Holding Time">
        <h3 class="group-title">Stage 2 â€” Holding Time</h3>
        <div class="field" style="margin-bottom:6px">
          <label for="burn">Holding Fuel Burn Rate <span class="hint" data-tip="Average fuel consumption in selected units per hour while holding.">?</span></label>
          <div class="input-wrap">
            <input id="burn" class="in" type="number" inputmode="decimal" step="0.1" min="0.01" autocomplete="off" placeholder="Enter holding fuel burn rate">
            <span class="unit-inside" data-role="burn">lbs/hr</span>
          </div>
          <div id="e-burn" class="error">Enter holding fuel burn rate.</div>
        </div>

        <section id="resultTime" class="result hidden" aria-live="polite">
          <div><strong>Estimated Holding Time (HH:MM)</strong></div>
          <div id="timeVal" style="font-weight:800">â€”:â€”</div>
        </section>

        <h4 class="group-title" style="margin-top:6px">Hold Timer</h4>
        <div id="timer" class="timer">
          <div id="timerDisplay" class="timer-readout">00:00</div>
          <div>
            <button id="startTimer" class="timbtn">Start</button>
            <button id="pauseTimer" class="timbtn">Pause</button>
            <button id="resetTimer" class="timbtn">Reset</button>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <button id="copyBtn" class="btn btn-muted">Copy Summary to Clipboard</button>
        </div>
      </section>

      <div class="grid" style="margin-top:6px">
        <button id="clearBtn" class="btn btn-muted">Clear</button>
      </div>
    </main>
  </div>

<script>
  // Basic error log for testing
  window.addEventListener('error', function(e){ try{ console.log('Bingo Fuel Pro error:', e && (e.message || e)); }catch(_){} });

  // Theme
  (function(){
    try{
      var saved = localStorage.getItem('bfp-theme');
      var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', saved || (prefersDark ? 'dark' : 'light'));
    }catch(e){}
  })();
  function toggleTheme(){
    var html = document.documentElement;
    var next = html.getAttribute('data-theme')==='dark'?'light':'dark';
    html.setAttribute('data-theme', next);
    try{ localStorage.setItem('bfp-theme', next); }catch(e){}
  }
  document.getElementById('toggleTheme').addEventListener('click', toggleTheme);

  // Sidebar
  var overlay=document.getElementById('overlay'), sidenav=document.getElementById('sidenav');
  document.getElementById('openNav').addEventListener('click', function(){ sidenav.classList.add('open'); overlay.classList.add('show'); });
  document.getElementById('closeNav').addEventListener('click', function(){ sidenav.classList.remove('open'); overlay.classList.remove('show'); });
  overlay.addEventListener('click', function(){ sidenav.classList.remove('open'); overlay.classList.remove('show'); });
  document.getElementById('toggleThemeSide').addEventListener('click', toggleTheme);

  // Units & Fuel Types
  var KG_PER_LB=1/2.20462;
  var SG={ '100LL':6.01,'AVGAS100':6.00,'MOGAS':6.20,'JETA':6.84,'JETB':6.50 };
  var state={ unit:'lbs', fuelType:'100LL', reserveMode:'volume' };
  (function loadPrefs(){
    try{
      var u=localStorage.getItem('bfp-unit'); if(u) state.unit=u;
      var f=localStorage.getItem('bfp-fuel'); if(f && SG[f]!=null) state.fuelType=f;
      var rm=localStorage.getItem('bfp-resmode'); if(rm==='time' || rm==='volume') state.reserveMode=rm;
    }catch(e){}
  })();

  var unitPills=[].slice.call(document.querySelectorAll('.pill[data-unit]'));
  var fuelTypeBox=document.getElementById('fuelTypes');
  var fuelPills=[].slice.call(document.querySelectorAll('.pill[data-fuel]'));

  function currentUnitLabel(){ return state.unit==='lbs'?'lbs':state.unit==='kg'?'kg':'gal'; }
  function setUnitLabel(el,txt){ if(!el) return; el.textContent=txt; el.classList.remove('fade'); void el.offsetWidth; el.classList.add('fade'); }

  var unitInsideEls={
    fob:document.querySelector('.unit-inside[data-role="fob"]'),
    dest:document.querySelector('.unit-inside[data-role="dest"]'),
    alt:document.querySelector('.unit-inside[data-role="alt"]'),
    res:document.querySelector('.unit-inside[data-role="res"]'),
    burn:document.querySelector('.unit-inside[data-role="burn"]'),
    resrate:document.querySelector('.unit-inside[data-role="resrate"]')
  };
  var uBingo=document.getElementById('u-bingo'), uHold=document.getElementById('u-hold');

  function updateUnitLabels(){
    var u=currentUnitLabel();
    setUnitLabel(unitInsideEls.fob,u);
    setUnitLabel(unitInsideEls.dest,u);
    setUnitLabel(unitInsideEls.alt,u);
    setUnitLabel(unitInsideEls.res,u);
    setUnitLabel(unitInsideEls.burn,u+'/hr');
    setUnitLabel(unitInsideEls.resrate,u+'/hr');
    setUnitLabel(uBingo,u);
    setUnitLabel(uHold,u);
  }
  function savePrefs(){ try{
    localStorage.setItem('bfp-unit',state.unit);
    localStorage.setItem('bfp-fuel',state.fuelType);
    localStorage.setItem('bfp-resmode',state.reserveMode);
  }catch(e){} }

  function setUnitUI(){
    unitPills.forEach(function(p){ p.setAttribute('aria-pressed', String(p.getAttribute('data-unit')===state.unit)); });
    fuelTypeBox.classList.toggle('show', state.unit==='gal');
    fuelPills.forEach(function(p){ p.setAttribute('aria-pressed', String(p.getAttribute('data-fuel')===state.fuelType)); });
    updateUnitLabels();
    recalc();
    savePrefs();
  }
  unitPills.forEach(function(p){ p.addEventListener('click', function(){ state.unit=p.getAttribute('data-unit'); setUnitUI(); }); });
  fuelPills.forEach(function(p){ p.addEventListener('click', function(){ state.fuelType=p.getAttribute('data-fuel'); setUnitUI(); }); });

  // Reserve mode segmented control
  var segBtns=[].slice.call(document.querySelectorAll('.segbtn'));
  var resVolumeBlock=document.getElementById('resVolumeBlock');
  var resTimeBlock=document.getElementById('resTimeBlock');
  segBtns.forEach(function(b){
    b.addEventListener('click', function(){
      state.reserveMode=b.getAttribute('data-resmode');
      segBtns.forEach(function(x){ x.setAttribute('aria-pressed', String(x.getAttribute('data-resmode')===state.reserveMode)); });
      resVolumeBlock.classList.toggle('hidden', state.reserveMode==='time');
      resTimeBlock.classList.toggle('hidden', state.reserveMode!=='time');
      updateEnterKeyHints();
      attachFieldNavigation();
      savePrefs(); recalc();
    });
  });
  (function applySavedResMode(){
    segBtns.forEach(function(x){ x.setAttribute('aria-pressed', String(x.getAttribute('data-resmode')===state.reserveMode)); });
    resVolumeBlock.classList.toggle('hidden', state.reserveMode==='time');
    resTimeBlock.classList.toggle('hidden', state.reserveMode!=='time');
  })();

  // Fields
  function $(id){ return document.getElementById(id); }
  var fob=$('fob'), toDest=$('toDest'), toAlt=$('toAlt'), reserve=$('reserve');
  var reserveTime=$('reserveTime'), reserveRate=$('reserveRate'), burn=$('burn');

  // "Touched" tracking for validation messages
  var touched = { fob:false, toDest:false, toAlt:false, reserve:false, reserveTime:false, reserveRate:false, burn:false };
  [ ['fob',fob],['toDest',toDest],['toAlt',toAlt],['reserve',reserve],['reserveTime',reserveTime],['reserveRate',reserveRate],['burn',burn] ].forEach(function(arr){
    var k=arr[0], el=arr[1]; if(!el) return;
    el.addEventListener('blur', function(){ touched[k]=true; recalc(); });
    el.addEventListener('input', function(){ if(el.value!=='') touched[k]=true; recalc(); });
    el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ touched[k]=true; } });
  });

  var eFob=$('e-fob'), eDest=$('e-dest'), eAlt=$('e-alt'), eRes=$('e-res'), eResTime=$('e-resTime'), eResRate=$('e-resRate'), eBurn=$('e-burn');

  var bingoWrap=$('resultBingo'), holdWrap=$('resultHold');
  var bingoVal=$('bingoVal'), holdVal=$('holdVal');
  var step2=$('step2');
  var timeWrap=$('resultTime'), timeVal=$('timeVal');

  var sticky=$('sticky'), stickyBingo=$('stickyBingo'), stickyHold=$('stickyHold');

  // Helpers
  function toLbs(x){ if(isNaN(x))return NaN; if(state.unit==='lbs')return x; if(state.unit==='kg')return x*2.20462; return x*SG[state.fuelType]; }
  function fromLbs(x){ if(isNaN(x))return NaN; if(state.unit==='lbs')return x; if(state.unit==='kg')return x*KG_PER_LB; return x/SG[state.fuelType]; }
  function parseNum(v){ var n=parseFloat(v); return isFinite(n)?n:NaN; }

  function isFilled(el){ return el && String(el.value).trim() !== ''; }
  function allInputsFilled(){
    return (state.reserveMode === 'volume')
      ? [fob, toDest, toAlt, reserve].every(isFilled)
      : [fob, toDest, toAlt, reserveTime, reserveRate].every(isFilled);
  }

  // Validation: only show once interacted
  function shouldShowErr(key, invalidCond, value){
    if(!invalidCond) return false;
    return touched[key] || (value!=='' && value!=null);
  }
  function validateStep1(){
    var ok=true;
    [eFob,eDest,eAlt,eRes,eResTime,eResRate].forEach(function(e){ if(e) e.style.display='none'; });

    var a=parseNum(fob.value), b=parseNum(toDest.value), c=parseNum(toAlt.value);
    if(!(a>0) && shouldShowErr('fob', true, fob.value)){ eFob.style.display='block'; ok=false; }
    if(!(b>=0) && shouldShowErr('toDest', true, toDest.value)){ eDest.style.display='block'; ok=false; }
    if(!(c>=0) && shouldShowErr('toAlt', true, toAlt.value)){ eAlt.style.display='block'; ok=false; }

    if(state.reserveMode==='volume'){
      var d=parseNum(reserve.value);
      if(!(d>=0) && shouldShowErr('reserve', true, reserve.value)){ eRes.style.display='block'; ok=false; }
    }else{
      var t=parseNum(reserveTime.value), r=parseNum(reserveRate.value);
      if(!(t>0) && shouldShowErr('reserveTime', true, reserveTime.value)){ eResTime.style.display='block'; ok=false; }
      if(!(r>0) && shouldShowErr('reserveRate', true, reserveRate.value)){ eResRate.style.display='block'; ok=false; }
    }
    return ok;
  }
  function validateBurn(){
    eBurn.style.display='none';
    var br=parseNum(burn.value);
    if(!(br>0) && shouldShowErr('burn', true, burn.value)){ eBurn.style.display='block'; return false; }
    return br>0;
  }

  function fmt(n){ return (Math.round(n*100)/100).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmtTime(minutes){ if(!(minutes>0)) return '00:00'; var h=Math.floor(minutes/60), m=minutes%60; return (''+h).padStart(2,'0')+':'+(''+m).padStart(2,'0'); }

  function reserveToLbs(){
    if(state.reserveMode==='volume'){
      return toLbs(parseNum(reserve.value));
    }else{
      var tMin=parseNum(reserveTime.value);
      var rate=parseNum(reserveRate.value);
      var rateLbs=toLbs(rate);
      if(!isFinite(tMin) || !isFinite(rateLbs)) return NaN;
      return rateLbs*(tMin/60);
    }
  }

  // Keyboard flow: Next â†’ Done â†’ dismiss
  function fieldOrder(){
    return (state.reserveMode === 'volume')
      ? [fob, toDest, toAlt, reserve]
      : [fob, toDest, toAlt, reserveTime, reserveRate];
  }
  function updateEnterKeyHints(){
    var order = fieldOrder();
    order.forEach(function(el, i){
      if(!el) return;
      try { el.setAttribute('enterkeyhint', i < order.length - 1 ? 'next' : 'done'); } catch(e){}
      try { el.setAttribute('inputmode','decimal'); el.setAttribute('pattern','[0-9]*'); } catch(e){}
    });
  }
  function attachFieldNavigation(){
    var order = fieldOrder();
    order.forEach(function(el, i){
      if(!el) return;
      el.onkeydown = function(e){
        if(e.key === 'Enter'){
          e.preventDefault();
          if(i < order.length - 1){
            order[i + 1].focus();
          } else {
            if(allInputsFilled()){ el.blur(); } // dismiss keyboard for visibility
          }
        }
      };
    });
  }

  // Recalc
  function recalc(){
    var stepValid = validateStep1();
    if (!stepValid || !allInputsFilled()){
      bingoWrap.classList.add('hidden');
      holdWrap.classList.add('hidden');
      step2.classList.remove('show');
      sticky.classList.remove('show');
      return;
    }
    var FOB=toLbs(parseNum(fob.value));
    var DEST=toLbs(parseNum(toDest.value));
    var ALT=toLbs(parseNum(toAlt.value));
    var RES=reserveToLbs();

    var bingo=DEST + ALT + RES;
    var hold=FOB - bingo;

    bingoVal.textContent=fmt(fromLbs(bingo));
    holdVal.textContent=fmt(fromLbs(hold));
    [bingoWrap,holdWrap].forEach(function(el){ el.classList.remove('hidden'); el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); });
    holdWrap.classList.toggle('warn', hold<0);

    stickyBingo.textContent=bingoVal.textContent+' '+currentUnitLabel();
    stickyHold.textContent=holdVal.textContent+' '+currentUnitLabel();
    sticky.classList.add('show');

    var wasHidden=!step2.classList.contains('show');
    step2.classList.add('show');
    if(wasHidden){ burn.classList.add('nudge'); setTimeout(function(){ burn.classList.remove('nudge'); },900); }

    if(validateBurn()){
      var BR=toLbs(parseNum(burn.value));
      var minutes=Math.max(0, Math.floor((hold/BR)*60));
      timeVal.textContent=fmtTime(minutes);
      timeWrap.classList.remove('hidden');
      document.getElementById('timer').style.display='block';
    }else{
      timeWrap.classList.add('hidden');
      document.getElementById('timer').style.display='none';
      resetTimer();
    }
  }

  burn.addEventListener('input', recalc);

  // Timer
  var tInt=null, tSec=0; var tDisp=document.getElementById('timerDisplay');
  function startTimer(){ if(tInt) return; tInt=setInterval(function(){ tSec++; var m=(''+Math.floor(tSec/60)).padStart(2,'0'); var s=(''+(tSec%60)).padStart(2,'0'); tDisp.textContent=m+':'+s; },1000); }
  function pauseTimer(){ clearInterval(tInt); tInt=null; }
  function resetTimer(){ clearInterval(tInt); tInt=null; tSec=0; tDisp.textContent='00:00'; }
  document.getElementById('startTimer').addEventListener('click', startTimer);
  document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
  document.getElementById('resetTimer').addEventListener('click', resetTimer);

  // Tooltips (stay open until tapping AWAY from both hint & tooltip)
  var activeTip=null, activeHint=null;
  function showTipFor(hintEl){
    hideTip();
    var tip=document.createElement('div');
    tip.className='tooltip';
    tip.textContent=hintEl.getAttribute('data-tip')||'';
    document.body.appendChild(tip);

    var r=hintEl.getBoundingClientRect();
    var tw=tip.offsetWidth, th=tip.offsetHeight;
    var top=r.top - th - 8, left=r.left + (r.width/2) - (tw/2);
    if(top < 8) top = r.bottom + 8;
    var pad=8, vw=window.innerWidth;
    if(left < pad) left = pad;
    if(left + tw > vw - pad) left = vw - pad - tw;
    tip.style.top = Math.max(8, top) + 'px';
    tip.style.left = left + 'px';

    requestAnimationFrame(function(){ tip.classList.add('show'); });
    activeTip = tip; activeHint = hintEl;
  }
  function hideTip(){
    if(activeTip){
      var t=activeTip; activeTip=null; activeHint=null;
      t.classList.remove('show');
      setTimeout(function(){ if(t && t.parentNode) t.parentNode.removeChild(t); }, 150);
    }
  }
  document.addEventListener('click', function(e){
    var hint = e.target.closest('.hint');
    var isTip = !!e.target.closest('.tooltip');

    if (hint){
      if (activeHint === hint) { hideTip(); }
      else { showTipFor(hint); }
      return;
    }
    if (isTip) return; // clicked inside tooltip -> keep open
    hideTip(); // clicked away
  }, true);
  document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hideTip(); });

  // Copy summary (with haptic feedback on success)
  document.getElementById('copyBtn').addEventListener('click', function(){
    var u=currentUnitLabel();
    var fuelBtn=document.querySelector('.pill[aria-pressed="true"][data-fuel]');
    var fuelTxt=fuelBtn?fuelBtn.textContent:'';
    var resModeText = state.reserveMode==='time'
      ? ('Reserve: '+(document.getElementById('reserveTime').value||'â€”')+' min @ '+(document.getElementById('reserveRate').value||'â€”')+' '+u+'/hr')
      : ('Reserve Fuel (Volume): '+(document.getElementById('reserve').value||'â€”')+' '+u);
    var summary=[
      'Bingo Fuel Pro â€“ Calculation Summary',
      'Units: '+u+(u==='gal' ? ' ('+fuelTxt+')' : ''),
      '',
      'Fuel On Board: '+(document.getElementById('fob').value||'â€”')+' '+u,
      'Fuel to Destination: '+(document.getElementById('toDest').value||'â€”')+' '+u,
      'Fuel to Alternate: '+(document.getElementById('toAlt').value||'â€”')+' '+u,
      resModeText,
      '',
      'Bingo Fuel: '+(document.getElementById('bingoVal').textContent||'â€”')+' '+u,
      'Fuel Remaining for Holding: '+(document.getElementById('holdVal').textContent||'â€”')+' '+u,
      'Holding Fuel Burn Rate: '+(document.getElementById('burn').value?document.getElementById('burn').value+' '+u+'/hr':'â€”'),
      'Estimated Holding Time (HH:MM): '+(document.getElementById('timeVal').textContent||'â€”:â€”')
    ].join('\n');

    try{
      navigator.clipboard.writeText(summary).then(function(){
        try{ if(navigator.vibrate) navigator.vibrate(10); }catch(_){}
        var btn=document.getElementById('copyBtn'); var prev=btn.textContent; btn.textContent='Copied!'; setTimeout(function(){ btn.textContent=prev; },1200);
      }, function(){
        alert('Copy failed â€“ select and copy manually:\n\n'+summary);
      });
    }catch(e){
      alert('Copy failed â€“ select and copy manually:\n\n'+summary);
    }
  });

  // Clear
  document.getElementById('clearBtn').addEventListener('click', function(){
    ['fob','toDest','toAlt','reserve','reserveTime','reserveRate','burn'].forEach(function(id){ var i=document.getElementById(id); if(i) i.value=''; });
    ['e-burn','e-res','e-resTime','e-resRate','e-fob','e-dest','e-alt'].forEach(function(id){ var e=document.getElementById(id); if(e) e.style.display='none'; });
    ['resultBingo','resultHold','resultTime'].forEach(function(id){ var el=document.getElementById(id); if(el) el.classList.add('hidden'); });
    document.getElementById('step2').classList.remove('show'); document.getElementById('timer').style.display='none';
    sticky.classList.remove('show');
    for(var k in touched) touched[k]=false;
  });

  // Splash (robust)
  (function(){
    var splash = document.getElementById('splash');
    function hideSplash(){
      try {
        if (!splash) return;
        splash.classList.add('fade');
        setTimeout(function(){ if (splash && splash.parentNode) splash.parentNode.removeChild(splash); }, 1200);
      } catch(e){}
    }
    try {
      window.addEventListener('load', function(){ setTimeout(hideSplash, 600); });
      setTimeout(hideSplash, 3000);
    } catch(e){
      setTimeout(hideSplash, 3000);
    }
  })();

  // Init UI
  (function init(){
    unitPills.forEach(function(p){ p.setAttribute('aria-pressed', String(p.getAttribute('data-unit')===state.unit)); });
    fuelTypeBox.classList.toggle('show',state.unit==='gal');
    fuelPills.forEach(function(p){ p.setAttribute('aria-pressed', String(p.getAttribute('data-fuel')===state.fuelType)); });
    updateUnitLabels();
    // apply reserve mode
    segBtns.forEach(function(x){ x.setAttribute('aria-pressed', String(x.getAttribute('data-resmode')===state.reserveMode)); });
    resVolumeBlock.classList.toggle('hidden', state.reserveMode==='time');
    resTimeBlock.classList.toggle('hidden', state.reserveMode!=='time');

    // keyboard flow
    updateEnterKeyHints();
    attachFieldNavigation();
  })();
</script>
</body>
</html>